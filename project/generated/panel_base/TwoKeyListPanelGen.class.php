<?php



/**
 * This is the base list class for the  TwoKey class.
 *
 * Do not edit this file, this file is overwritten on any code regenerations. Make any changes you need to the subclass.
 *
 * @package My QCubed Application
 * @subpackage PanelBaseObjects
 */
abstract class TwoKeyListPanelGen extends QPanel {
	/** @var QPanel **/
	protected $pnlFilter;

	/** @var QTextBox **/
	protected $txtFilter;

	/** @var QPanel **/
	protected $pnlButtons;

	/** @var QButton **/
	protected $btnNew;

	/** @var TwoKeyList **/
	protected $dtgTwoKeies;


	public function __construct($objParent, $strControlId = null) {
		parent::__construct($objParent, $strControlId);

		$this->CreateFilterPanel();
		$this->dtgTwoKeies_Create();
		$this->dtgTwoKeies->SetDataBinder('BindData', $this);
		$this->CreateButtonPanel();
	}

   /**
	* Creates the data grid and prepares it to be row clickable. Override for additional creation operations.
	**/
	protected function dtgTwoKeies_Create() {
		$this->dtgTwoKeies = new TwoKeyList($this);
		$this->dtgTwoKeies_CreateColumns();
		$this->dtgTwoKeies_MakeEditable();
		$this->dtgTwoKeies->RowParamsCallback = [$this, "dtgTwoKeies_GetRowParams"];
			$this->dtgTwoKeies->LinkedNode = QQN::TwoKey();
	}

   /**
	* Calls the list connector to add the columns. Override to customize column creation.
	**/
	protected function dtgTwoKeies_CreateColumns() {
		$this->dtgTwoKeies->CreateColumns();
	}

	protected function dtgTwoKeies_MakeEditable() {
		$this->dtgTwoKeies->AddAction(new QCellClickEvent(), new QAjaxControlAction($this, 'dtgTwoKeies_CellClick', null, null, '$j(this).parent().data("value")'));
		$this->dtgTwoKeies->AddCssClass('clickable-rows');
	}

	protected function dtgTwoKeies_CellClick($strFormId, $strControlId, $strParameter) {
		if ($strParameter) {
			$this->EditItem($strParameter);
		}
	}
	public function dtgTwoKeies_GetRowParams($objRowObject, $intRowIndex) {
		$strKey = $objRowObject->PrimaryKey();
		$params['data-value'] = $strKey;
		return $params;
	}

	/**
	 *
	 **/
	protected function CreateFilterPanel() {
		$this->pnlFilter = new QPanel($this);	// div wrapper for filter objects
		$this->pnlFilter->AutoRenderChildren = true;

		$this->txtFilter = new QTextBox($this->pnlFilter);
		$this->txtFilter->Placeholder = QApplication::Translate('Search...');
		$this->txtFilter->TextMode = QTextMode::Search;
		$this->AddFilterActions();
	}

	protected function AddFilterActions() {
		$this->txtFilter->AddAction(new QInputEvent(300), new QAjaxControlAction ($this, 'FilterChanged'));
		$this->txtFilter->AddActionArray(new QEnterKeyEvent(),
			[
				new QAjaxControlAction($this, 'FilterChanged'),
				new QTerminateAction()
			]
		);
	}

	protected function FilterChanged() {
		$this->dtgTwoKeies->Refresh();
	}

	/**
	 *	Bind Data to the list control.
	 **/
	public function BindData() {
		$objCondition = $this->GetCondition();
		$this->dtgTwoKeies->BindData($objCondition);
	}


	/**
	 *  Get the condition for the data binder.
	 *  @return QQCondition;
	 **/
	protected function GetCondition() {
		$strSearchValue = $this->txtFilter->Text;
		$strSearchValue = trim($strSearchValue);

		if (is_null($strSearchValue) || $strSearchValue === '') {
			 return QQ::All();
		} else {
			return QQ::OrCondition(
				QQ::Like(QQN::TwoKey()->Server, "%" . $strSearchValue . "%"),
            QQ::Like(QQN::TwoKey()->Directory, "%" . $strSearchValue . "%"),
            QQ::Like(QQN::TwoKey()->FileName, "%" . $strSearchValue . "%"),
            QQ::Equal(QQN::TwoKey()->PersonId, $strSearchValue),
            QQ::Equal(QQN::TwoKey()->ProjectId, $strSearchValue)
			);
		}

	}



	/**
	 *
	 **/
	protected function CreateButtonPanel() {
		$this->pnlButtons = new QPanel ($this);
		$this->pnlButtons->AutoRenderChildren = true;

		$this->btnNew = new QJqButton ($this->pnlButtons);
		$this->btnNew->Text = QApplication::Translate ('New');
		$this->btnNew->AddAction (new QClickEvent(), new QAjaxControlAction ($this, 'btnNew_Click'));
	}

	protected function btnNew_Click($strFormId, $strControlId, $strParameter) {
		$this->EditItem();
	}

	protected function EditItem ($strKey = null) {
		$strQuery = '';
		if ($strKey) {
			$keys = explode (':', $strKey);
			$params['strServer'] = $keys[0];
			$params['strDirectory'] = $keys[1];
			$strQuery = '?' . http_build_query($params, '', '&');
		}
		$strEditPageUrl = __VIRTUAL_DIRECTORY__ . __FORMS__ . '/two_key_edit.php' . $strQuery;
		QApplication::Redirect ($strEditPageUrl);
	}

}
